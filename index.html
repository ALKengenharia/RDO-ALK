<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>ALK Engenharia - RDO Cloud v17.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --blue-dark: #0a1931; --accent: #b90000; --orange: #f39c12; --gray-dark: #2c3e50; --green: #27ae60; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #eef2f5; margin: 0; padding: 20px; display: flex; gap: 20px; }
        .sidebar { width: 300px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); height: 95vh; display: flex; flex-direction: column; }
        .main-content { flex: 1; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow-y: auto; height: 95vh; }
        .form-section { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
        .form-section h4 { margin: 0 0 15px 0; color: var(--blue-dark); text-transform: uppercase; font-size: 13px; border-left: 4px solid var(--accent); padding-left: 10px; }
        .grid-input { display: flex; gap: 10px; margin-bottom: 10px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        input, textarea, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 13px; }
        label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 3px; color: #555; }
        .btn { padding: 10px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; transition: 0.3s; text-align: center; text-decoration: none; display: block; margin-bottom: 5px; }
        .btn-clear { background: var(--orange); width: 100%; margin-bottom: 10px; }
        .btn-pdf { background: var(--blue-dark); width: 100%; font-size: 16px; margin-top: 15px; }
        .btn-add { background: var(--gray-dark); font-size: 10px; margin-top: 5px; width: auto; display: inline-block; }
        .btn-admin { background: #7f8c8d; width: 100%; font-size: 11px; }
        .btn-link { background: var(--blue-dark); font-size: 11px; }
        .btn-green { background: var(--green); font-size: 11px; }
        .btn-delete { background: var(--accent); font-size: 10px; padding: 4px; display: inline-block; margin: 2px; }
        .btn-edit { background: var(--orange); font-size: 10px; padding: 4px; display: inline-block; margin: 2px; }
        .pdf-block { width: 180mm; background: white; margin-bottom: 10px; }
        .pdf-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .pdf-table td { border: 1px solid #000; padding: 6px; font-size: 10px; word-wrap: break-word; vertical-align: top; }
        .bg-gray { background: #eeeeee; font-weight: bold; text-align: center; text-transform: uppercase; }
        .text-box { border: 1px solid #000; min-height: 50px; padding: 8px; font-size: 10px; white-space: pre-wrap; margin-bottom: 5px; }
        #pdf-render-zone { position: absolute; left: -9999px; top: 0; width: 185mm; }
        .modal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
        .modal-content { background:white; margin:5% auto; padding:20px; width:50%; border-radius:8px; max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body>

<div id="modalObras" class="modal">
    <div class="modal-content">
        <h3>Gerenciar Obras (Nuvem)</h3>
        <table style="width:100%; border-collapse: collapse;" border="1">
            <thead><tr class="bg-gray"><td>Nome da Obra</td><td style="width:120px">A√ß√µes</td></tr></thead>
            <tbody id="lista-obras-gerenciar"></tbody>
        </table>
        <br>
        <button class="btn btn-admin" onclick="fecharModal()">FECHAR</button>
    </div>
</div>

<div class="sidebar">
    <h3 style="margin:0; font-size:16px;">SISTEMA ALK</h3>
    <div id="history-list" style="flex:1; overflow-y:auto; margin-top:10px;"></div>
    <hr style="width:100%">
    <a href="https://drive.google.com/drive/folders/1y-OtO72DP11CK3K2Z4zVvYKWucdfVOqv?usp=drive_link" target="_blank" class="btn btn-link">üìÇ VER RDO¬¥S GERADOS</a>
    <button class="btn btn-green" onclick="cadastrarObra()">üèóÔ∏è CADASTRAR NOVA OBRA</button>
    <button class="btn btn-admin" onclick="abrirModal()">‚öôÔ∏è OBRAS CADASTRADAS</button>
    <a href="https://docs.google.com/spreadsheets/d/1Rz1e44P9wjxqwzZx_LEj2eFiKA87ILRL/edit?usp=sharing" target="_blank" class="btn btn-link">üìä VER EFETIVO NOMINAL</a>
</div>

<div class="main-content">
    <button class="btn btn-clear" onclick="clearCurrentForm()">üßπ NOVO RELAT√ìRIO</button>

    <div class="form-section">
        <h4>1. Identifica√ß√£o</h4>
        <div class="grid-3">
            <div style="grid-column: span 3;">
                <label>Selecionar Obra (Sincronizado)</label>
                <select id="sel-obra" onchange="carregarDadosObra()">
                    <option value="">-- Carregando obras... --</option>
                </select>
            </div>
            <div><label>N¬∫ RDO</label><input type="text" id="in-num" readonly style="background:#f9f9f9"></div>
            <div><label>Data Atual</label><input type="date" id="in-data"></div>
            <div><label>Obra</label><input type="text" id="in-obra"></div>
            <div><label>Endere√ßo</label><input type="text" id="in-endereco"></div>
            <div><label>Data In√≠cio</label><input type="date" id="in-data-inicio"></div>
            <div><label>Prazo</label><input type="text" id="in-prazo"></div>
            <div style="grid-column: span 3;"><label>Respons√°vel T√©cnico</label><input type="text" id="in-resp-tec"></div>
        </div>
    </div>

    <div class="form-section">
        <h4>2. Clima</h4>
        <div class="grid-3">
            <div><label>Manh√£</label><select id="in-clima-m"><option>ENSOLARADO</option><option>NUBLADO</option><option>CHUVA</option></select></div>
            <div><label>Tarde</label><select id="in-clima-t"><option>ENSOLARADO</option><option>NUBLADO</option><option>CHUVA</option></select></div>
            <div><label>Noite</label><select id="in-clima-n"><option>NORMAL</option><option>NUBLADO</option><option>CHUVA</option><option>SEM OBRA</option></select></div>
        </div>
    </div>

    <div class="form-section">
        <h4>3. Equipe e Equipamentos</h4>
        <div id="mo-area"><div class="grid-input"><input type="text" placeholder="Fun√ß√£o" class="mo-funcao"> <input type="number" placeholder="Qtd" class="mo-qtd"></div></div>
        <button class="btn btn-add" onclick="addRow('mo-area')">+ Fun√ß√£o</button>
        <hr style="margin:10px 0; opacity:0.1">
        <div id="eq-area"><div class="grid-input"><input type="text" placeholder="Equipamento" class="eq-nome"> <input type="number" class="eq-qtd" placeholder="Qtd"> <select class="eq-tipo"><option>PR√ìPRIO</option><option>LOCADO</option></select></div></div>
        <button class="btn btn-add" onclick="addRow('eq-area')">+ Equipamento</button>
    </div>
      
    <div class="form-section">
        <h4>4. Relato</h4>
        <label>Tarefas Realizadas</label><textarea id="in-tarefas" rows="6"></textarea>
        <label>Ocorr√™ncias</label><textarea id="in-ocorrencias" rows="3"></textarea>
    </div>

    <div class="form-section">
        <h4>5. Fotos e Logos</h4>
        <div class="grid-3">
            <div><label>Logo ALK</label><input type="file" onchange="saveImg(this, 'alk_logo')"></div>
            <div><label>Rodap√©</label><input type="file" onchange="saveImg(this, 'alk_footer')"></div>
            <div><label>Fotos</label><input type="file" id="in-fotos" multiple onchange="loadPhotos(this)"></div>
        </div>
    </div>

    <button class="btn btn-pdf" id="btn-gerar" onclick="generatePDF()">üíæ GERAR RDO</button>
</div>

<div id="pdf-render-zone">
    <div id="block-header" class="pdf-block">
        <table class="pdf-table">
            <tr>
                <td rowspan="4" id="out-logo" style="width:30%; text-align:center; vertical-align: middle;">ALK</td>
                <td colspan="2" class="bg-gray">RELAT√ìRIO DI√ÅRIO DE OBRA (RDO)</td>
                <td style="width:15%">N¬∫: <strong id="out-num"></strong></td>
            </tr>
            <tr><td colspan="2"><strong>OBRA:</strong> <span id="out-obra"></span></td><td><strong>DATA:</strong> <span id="out-data"></span></td></tr>
            <tr><td colspan="2"><strong>ENDERE√áO:</strong> <span id="out-endereco"></span></td><td><strong>IN√çCIO:</strong> <span id="out-data-inicio"></span></td></tr>
            <tr><td><strong>RESP. T√âCNICO:</strong> <span id="out-resp-tec"></span></td><td><strong>PRAZO:</strong> <span id="out-prazo"></span></td><td><strong>CONTRATO:</strong> MATEC-TPS</td></tr>
        </table>
        <table class="pdf-table" style="margin-top:5px">
            <tr class="bg-gray"><td>MANH√É</td><td>TARDE</td><td>NOITE</td></tr>
            <tr style="text-align:center"><td id="out-clima-m"></td><td id="out-clima-t"></td><td id="out-clima-n"></td></tr>
        </table>
    </div>
    <div id="block-mo" class="pdf-block">
        <div style="display:flex; gap:2px;">
            <table class="pdf-table" style="width:50%">
                <tr class="bg-gray"><td colspan="2">M√ÉO DE OBRA</td></tr>
                <tbody id="pdf-mo"></tbody>
            </table>
            <table class="pdf-table" style="width:50%"><tr class="bg-gray"><td colspan="3">EQUIPAMENTOS</td></tr><tbody id="pdf-eq"></tbody></table>
        </div>
    </div>
    <div id="block-tarefas" class="pdf-block"><div class="bg-gray" style="border:1px solid #000; padding:2px;">ATIVIDADES REALIZADAS</div><div id="out-tarefas" class="text-box"></div></div>
    <div id="block-ocorrencias" class="pdf-block"><div class="bg-gray" style="border:1px solid #000; padding:2px;">OCORR√äNCIAS</div><div id="out-ocorrencias" class="text-box"></div></div>
    
    <div id="block-assinaturas" class="pdf-block" style="border:none;">
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; text-align:center; font-size:8px; margin-top:10px;">
            <div style="border-top:1px solid #000; padding-top:2px;">RESPONS√ÅVEL T√âCNICO ALK</div>
            <div style="border-top:1px solid #000; padding-top:2px;">CONTRATADA</div>
            <div style="border-top:1px solid #000; padding-top:2px;">FISCALIZA√á√ÉO</div>
        </div>
    </div>

    <div id="block-rodape-img" style="width:180mm; text-align:center;">
        <div id="out-footer-render"></div>
    </div>
</div>

<script>
    const DATABASE_URL = "https://script.google.com/macros/s/AKfycbwtVGkFwyybyK7ws6d8yp_WN_SkwOqyp250qTkc_JV3r1930cGgrRTSbFcsWPM9NPjHqA/exec";
    let reports = [];
    let obras = [];
    let photos = [];

    window.onload = async () => { 
        loadSettings(); 
        await carregarDadosNuvem(); 
    };

    async function carregarDadosNuvem() {
        try {
            const response = await fetch(DATABASE_URL);
            const data = await response.json();
            reports = data.historico || [];
            obras = data.obras || [];
            renderHistory();
            atualizarListaObras();
            setNum();
        } catch (e) { 
            console.error("Erro na nuvem:", e); 
            document.getElementById('sel-obra').innerHTML = '<option>Erro ao carregar</option>';
        }
    }

  function setNum() { 
    let ultimoNumero = 0;

    if (reports.length > 0) {
        // Mapeia todos os n√∫meros removendo o "/2026" e pega o maior
        const numeros = reports.map(r => {
            const numApenas = parseInt(r.num.split('/')[0]);
            return isNaN(numApenas) ? 0 : numApenas;
        });
        ultimoNumero = Math.max(...numeros);
    }

    const proximo = (ultimoNumero + 1).toString().padStart(3, '0');
    document.getElementById('in-num').value = proximo + "/2026"; 
}

    function atualizarListaObras() {
        const sel = document.getElementById('sel-obra');
        sel.innerHTML = '<option value="">-- Selecione uma obra --</option>';
        obras.forEach((o, index) => { sel.innerHTML += `<option value="${index}">${o.nome}</option>`; });
    }

    function carregarDadosObra() {
        const idx = document.getElementById('sel-obra').value; if(idx === "") return;
        const o = obras[idx];
        document.getElementById('in-obra').value = o.nome;
        document.getElementById('in-endereco').value = o.endereco;
        if(o.inicio) document.getElementById('in-data-inicio').value = o.inicio.split('T')[0];
        document.getElementById('in-prazo').value = o.prazo;
        document.getElementById('in-resp-tec').value = o.resp;
    }

    async function cadastrarObra() {
        const nome = prompt("Nome da Obra:"); if(!nome) return;
        const nova = {
            nome: nome,
            endereco: prompt("Endere√ßo:"),
            inicio: prompt("Data In√≠cio (AAAA-MM-DD):"),
            prazo: prompt("Prazo:"),
            resp: prompt("Respons√°vel:")
        };
        await fetch(DATABASE_URL, { method: 'POST', body: JSON.stringify({ acao: 'salvarObra', dados: nova }) });
        await carregarDadosNuvem();
    }

    async function excluirObra(i) {
        if(confirm("Excluir da nuvem?")) {
            await fetch(DATABASE_URL, { method: 'POST', body: JSON.stringify({ acao: 'excluirObra', nome: obras[i].nome }) });
            await carregarDadosNuvem();
            abrirModal();
        }
    }

    function abrirModal() {
        const lista = document.getElementById('lista-obras-gerenciar');
        lista.innerHTML = obras.map((o, i) => `<tr><td style="padding:5px;">${o.nome}</td><td style="text-align:center;"><button class="btn btn-delete" onclick="excluirObra(${i})">EXCLUIR</button></td></tr>`).join('');
        document.getElementById('modalObras').style.display = 'block';
    }
    function fecharModal() { document.getElementById('modalObras').style.display = 'none'; }

    function addRow(id) {
        const div = document.createElement('div'); div.className = 'grid-input';
        div.innerHTML = id === 'mo-area' ? '<input type="text" placeholder="Fun√ß√£o" class="mo-funcao"> <input type="number" placeholder="Qtd" class="mo-qtd">' : '<input type="text" class="eq-nome"> <input type="number" class="eq-qtd"> <select class="eq-tipo"><option>PR√ìPRIO</option><option>LOCADO</option></select>';
        document.getElementById(id).appendChild(div);
    }

    function saveImg(i, k) { const r = new FileReader(); r.onload = (e) => { localStorage.setItem(k, e.target.result); loadSettings(); }; r.readAsDataURL(i.files[0]); }
    function loadSettings() {
        const l = localStorage.getItem('alk_logo'), f = localStorage.getItem('alk_footer');
        if(l) document.getElementById('out-logo').innerHTML = `<img src="${l}" style="max-height:55px; max-width:100%;">`;
        if(f) document.getElementById('out-footer-render').innerHTML = `<img src="${f}" style="width:100%; height:auto; max-height:22mm;">`;
    }
    function loadPhotos(i) { photos = []; Array.from(i.files).forEach(f => { const r = new FileReader(); r.onload = (e) => photos.push(e.target.result); r.readAsDataURL(f); }); }

    async function generatePDF() {
        const btn = document.getElementById('btn-gerar'); btn.innerText = "‚è≥ GERANDO E SINCRONIZANDO...";
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        // Sync Visuals
        document.getElementById('out-num').innerText = document.getElementById('in-num').value;
        document.getElementById('out-obra').innerText = document.getElementById('in-obra').value;
        document.getElementById('out-data').innerText = document.getElementById('in-data').value;
        document.getElementById('out-endereco').innerText = document.getElementById('in-endereco').value;
        document.getElementById('out-data-inicio').innerText = document.getElementById('in-data-inicio').value;
        document.getElementById('out-prazo').innerText = document.getElementById('in-prazo').value;
        document.getElementById('out-resp-tec').innerText = document.getElementById('in-resp-tec').value;
        document.getElementById('out-clima-m').innerText = document.getElementById('in-clima-m').value;
        document.getElementById('out-clima-t').innerText = document.getElementById('in-clima-t').value;
        document.getElementById('out-clima-n').innerText = document.getElementById('in-clima-n').value;
        document.getElementById('out-tarefas').innerText = document.getElementById('in-tarefas').value;
        document.getElementById('out-ocorrencias').innerText = document.getElementById('in-ocorrencias').value;

        const moT = document.getElementById('pdf-mo'); moT.innerHTML = '';
        document.querySelectorAll('#mo-area .grid-input').forEach(r => {
            const f = r.querySelector('.mo-funcao').value; if(f) moT.innerHTML += `<tr><td>${f}</td><td style="text-align:center">${r.querySelector('.mo-qtd').value}</td></tr>`;
        });
        const eqT = document.getElementById('pdf-eq'); eqT.innerHTML = '';
        document.querySelectorAll('#eq-area .grid-input').forEach(r => {
            const n = r.querySelector('.eq-nome').value; if(n) eqT.innerHTML += `<tr><td>${n}</td><td style="text-align:center">${r.querySelector('.eq-qtd').value}</td><td style="font-size:8px;">${r.querySelector('.eq-tipo').value}</td></tr>`;
        });

        const carimbarRodape = async (p) => {
            const canvasR = await html2canvas(document.getElementById('block-rodape-img'), { scale: 3 });
            p.addImage(canvasR.toDataURL('image/jpeg', 1.0), 'JPEG', 15, 270, 180, (canvasR.height * 180) / canvasR.width);
        };

        let currentY = 10;
        const blocks = ['block-header', 'block-mo', 'block-tarefas', 'block-ocorrencias'];
        
        for (let id of blocks) {
            const canvas = await html2canvas(document.getElementById(id), { scale: 3 });
            const h = (canvas.height * 180) / canvas.width;
            if (currentY + h > 260) { await carimbarRodape(pdf); pdf.addPage(); currentY = 10; }
            pdf.addImage(canvas.toDataURL('image/jpeg', 1.0), 'JPEG', 15, currentY, 180, h);
            currentY += h + 5;
        }

        if (photos.length > 0) {
            if (currentY > 240) { await carimbarRodape(pdf); pdf.addPage(); currentY = 15; }
            pdf.setFontSize(10); pdf.setFillColor(238, 238, 238); pdf.rect(15, currentY, 180, 7, 'F'); pdf.rect(15, currentY, 180, 7, 'S');
            pdf.text("REGISTRO FOTOGR√ÅFICO", 105, currentY + 5, { align: "center" });
            currentY += 10;
            for (let i = 0; i < photos.length; i++) {
                if (currentY > 210) { await carimbarRodape(pdf); pdf.addPage(); currentY = 20; }
                const isLeft = i % 2 === 0;
                pdf.addImage(photos[i], 'JPEG', isLeft ? 15 : 105, currentY, 85, 55);
                if (!isLeft || i === photos.length - 1) currentY += 60;
            }
        }

        currentY += 30;
        if (currentY > 230) { await carimbarRodape(pdf); pdf.addPage(); currentY = 20; }
        const canvasAss = await html2canvas(document.getElementById('block-assinaturas'), { scale: 3 });
        pdf.addImage(canvasAss.toDataURL('image/jpeg', 1.0), 'JPEG', 15, currentY, 180, (canvasAss.height * 180) / canvasAss.width);
        await carimbarRodape(pdf);

        // SALVAR NA NUVEM (PLANILHA)
        try {
            await fetch(DATABASE_URL, {
                method: 'POST',
                body: JSON.stringify({ acao: 'salvarRDO', dados: { num: document.getElementById('in-num').value, data: document.getElementById('in-data').value } })
            });
        } catch(e) { console.error("Erro ao sincronizar RDO:", e); }

        pdf.save(`RDO_${document.getElementById('in-num').value.replace('/','-')}.pdf`);
        await carregarDadosNuvem();
        btn.innerText = "üíæ GERAR RDO";
    }

    function renderHistory() { document.getElementById('history-list').innerHTML = reports.slice().reverse().map(r => `<div style="font-size:11px; padding:5px; border-bottom:1px solid #eee">RDO ${r.num} - ${r.data.split('T')[0]}</div>`).join(''); }
    function clearCurrentForm() { location.reload(); }
</script>
</body>
</html>


